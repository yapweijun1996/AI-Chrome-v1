<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced AI System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .warning {
            border-color: #ffc107;
            background-color: #fff3cd;
        }
        .ambiguous-queries {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px;
            margin: 10px 0;
        }
        .clarification-example {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 10px;
            margin: 10px 0;
        }
        .pricing-example {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Enhanced AI System Test Suite</h1>
        <p>This page tests the enhanced intent classification, multi-step planning, and clarification systems.</p>
        
        <div class="test-section">
            <h3>üìã Enhancement Summary</h3>
            <div class="test-result success">
‚úÖ Enhanced Intent Classification
   - Ambiguity detection and confidence scoring
   - Support for SHOPPING intent category
   - Alternative interpretation analysis
   - Missing context identification

‚úÖ Multi-Step Planning Improvements
   - Query refinement for vague terms
   - Multi-source search capabilities
   - Location-aware search strategies
   - Enhanced pricing research tools

‚úÖ Feedback Loop System
   - Clarification request management
   - Interactive prompt generation
   - Context gathering workflows
   - Response processing and routing

‚úÖ Additional Search Tools
   - Pricing research from multiple sources
   - Source comparison and synthesis
   - Location-specific search terms
   - Credibility analysis

‚úÖ Chat Linkage Improvements
   - Enhanced message routing
   - Better error handling and fallbacks
   - Improved URL resolution
   - Session management for clarifications
            </div>
        </div>

        <div class="test-section">
            <h3>üîç Intent Classification Test</h3>
            <input type="text" id="intentInput" class="test-input" placeholder="Enter a query to test intent classification..." value="find ipad price">
            <button class="test-button" onclick="testIntentClassification()">Test Basic Classification</button>
            <button class="test-button" onclick="testEnhancedClassification()">Test Enhanced Classification</button>
            <div id="intentResult" class="test-result"></div>
            
            <div class="ambiguous-queries">
                <h4>ü§î Try These Ambiguous Queries:</h4>
                <button class="test-button" onclick="setTestQuery('research that')">research that</button>
                <button class="test-button" onclick="setTestQuery('buy the best one')">buy the best one</button>
                <button class="test-button" onclick="setTestQuery('help me with this')">help me with this</button>
                <button class="test-button" onclick="setTestQuery('find it')">find it</button>
                <button class="test-button" onclick="setTestQuery('price comparison')">price comparison</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üí∞ Pricing Research Test</h3>
            <input type="text" id="pricingInput" class="test-input" placeholder="Enter a product to research pricing..." value="iPad Air Singapore">
            <button class="test-button" onclick="testPricingResearch()">Test Pricing Research</button>
            <div id="pricingResult" class="test-result"></div>
            
            <div class="pricing-example">
                <h4>üí° Pricing Research Features:</h4>
                <ul>
                    <li><strong>Multi-Source Search:</strong> Official stores, retailers, comparison sites</li>
                    <li><strong>Location Awareness:</strong> Singapore-specific pricing and availability</li>
                    <li><strong>Price Analysis:</strong> Range calculation, average pricing, recommendations</li>
                    <li><strong>Source Credibility:</strong> Weighted analysis based on source authority</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>‚ùì Clarification System Test</h3>
            <input type="text" id="clarificationInput" class="test-input" placeholder="Enter an ambiguous query..." value="research that thing">
            <button class="test-button" onclick="testClarificationSystem()">Test Clarification</button>
            <div id="clarificationResult" class="test-result"></div>
            
            <div class="clarification-example">
                <h4>üîÑ Clarification Flow:</h4>
                <ol>
                    <li><strong>Ambiguity Detection:</strong> AI identifies unclear queries</li>
                    <li><strong>Context Analysis:</strong> Determines what information is missing</li>
                    <li><strong>Prompt Generation:</strong> Creates specific clarification questions</li>
                    <li><strong>Response Processing:</strong> Handles user responses and refines intent</li>
                    <li><strong>Action Routing:</strong> Proceeds with clarified intent</li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <h3>üîß Multi-Step Planning Test</h3>
            <input type="text" id="planningInput" class="test-input" placeholder="Enter a complex goal..." value="find best laptop under $1000 in Singapore">
            <button class="test-button" onclick="testEnhancedPlanning()">Test Enhanced Planning</button>
            <div id="planningResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h3>üìä System Status</h3>
            <button class="test-button" onclick="checkSystemStatus()">Check System Status</button>
            <div id="statusResult" class="test-result"></div>
        </div>
    </div>

    <script>
        // Test functions
        function setTestQuery(query) {
            document.getElementById('intentInput').value = query;
        }

        async function testIntentClassification() {
            const input = document.getElementById('intentInput').value;
            const resultDiv = document.getElementById('intentResult');
            
            resultDiv.textContent = 'Testing basic intent classification...';
            resultDiv.className = 'test-result';
            
            try {
                // Simulate basic classification test
                const mockResult = {
                    intent: inferBasicIntent(input),
                    confidence: Math.random() * 0.4 + 0.6, // 0.6-1.0
                    reasoning: `Basic classification based on keywords in: "${input}"`,
                    suggestedAction: `Perform ${inferBasicIntent(input).toLowerCase()} task`
                };
                
                resultDiv.textContent = JSON.stringify(mockResult, null, 2);
                resultDiv.className = 'test-result success';
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        async function testEnhancedClassification() {
            const input = document.getElementById('intentInput').value;
            const resultDiv = document.getElementById('intentResult');
            
            resultDiv.textContent = 'Testing enhanced intent classification with ambiguity detection...';
            resultDiv.className = 'test-result';
            
            try {
                // Simulate enhanced classification
                const isAmbiguous = checkAmbiguity(input);
                const mockResult = {
                    success: true,
                    classification: {
                        intent: inferBasicIntent(input),
                        confidence: isAmbiguous ? Math.random() * 0.4 + 0.3 : Math.random() * 0.3 + 0.7,
                        reasoning: `Enhanced analysis of: "${input}"`,
                        suggestedAction: `Perform enhanced ${inferBasicIntent(input).toLowerCase()} with multi-source approach`,
                        ambiguityFactors: isAmbiguous ? ['vague_pronouns', 'missing_context'] : [],
                        missingContext: isAmbiguous ? ['what', 'where'] : [],
                        alternativeInterpretations: isAmbiguous ? [
                            { intent: 'RESEARCH', confidence: 0.4, reasoning: 'Could be research request' },
                            { intent: 'SHOPPING', confidence: 0.3, reasoning: 'Could be shopping query' }
                        ] : []
                    },
                    needsClarification: isAmbiguous,
                    ambiguity: isAmbiguous ? {
                        isAmbiguous: true,
                        reason: 'insufficient_context',
                        factors: ['vague_pronouns', 'missing_context'],
                        missingContext: ['what', 'where'],
                        alternatives: [
                            { intent: 'RESEARCH', confidence: 0.4 },
                            { intent: 'SHOPPING', confidence: 0.3 }
                        ]
                    } : { isAmbiguous: false }
                };
                
                resultDiv.textContent = JSON.stringify(mockResult, null, 2);
                resultDiv.className = isAmbiguous ? 'test-result warning' : 'test-result success';
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        async function testPricingResearch() {
            const input = document.getElementById('pricingInput').value;
            const resultDiv = document.getElementById('pricingResult');
            
            resultDiv.textContent = 'Testing pricing research tools...';
            resultDiv.className = 'test-result';
            
            try {
                // Simulate pricing research
                const mockResult = {
                    ok: true,
                    observation: `Pricing research completed for "${input}" in singapore. Found 3 sources.`,
                    data: {
                        query: input,
                        location: 'singapore',
                        timestamp: Date.now(),
                        sources: [
                            {
                                sourceType: 'official',
                                results: ['Apple Singapore Official Store'],
                                extractedPrices: { prices: [899, 1099, 1299] }
                            },
                            {
                                sourceType: 'retail',
                                results: ['Challenger', 'Courts', 'Harvey Norman'],
                                extractedPrices: { prices: [879, 1089, 1279] }
                            },
                            {
                                sourceType: 'comparison',
                                results: ['PricePanda', 'iPrice'],
                                extractedPrices: { prices: [869, 1079, 1269] }
                            }
                        ],
                        priceRange: { min: 869, max: 1299, currency: 'SGD' },
                        averagePrice: { value: 1076, currency: 'SGD', sampleSize: 9 },
                        recommendations: [
                            {
                                type: 'best_value',
                                title: 'Best Value Option',
                                description: 'Based on price-to-feature ratio analysis'
                            },
                            {
                                type: 'official_source',
                                title: 'Buy from Official Source',
                                description: 'Guaranteed authenticity and warranty coverage'
                            }
                        ]
                    }
                };
                
                resultDiv.textContent = JSON.stringify(mockResult, null, 2);
                resultDiv.className = 'test-result success';
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        async function testClarificationSystem() {
            const input = document.getElementById('clarificationInput').value;
            const resultDiv = document.getElementById('clarificationResult');
            
            resultDiv.textContent = 'Testing clarification system...';
            resultDiv.className = 'test-result';
            
            try {
                // Simulate clarification flow
                const mockResult = {
                    success: true,
                    clarificationId: `clarification_${Date.now()}_abc123`,
                    request: {
                        id: `clarification_${Date.now()}_abc123`,
                        originalMessage: input,
                        status: 'pending',
                        attempts: 0,
                        prompts: [
                            {
                                type: 'context_gathering',
                                message: 'To help you better, I need some additional information:',
                                questions: [
                                    { type: 'what', question: 'What specifically are you looking for?', required: true },
                                    { type: 'where', question: 'Where should I look for this information?', required: true }
                                ]
                            }
                        ]
                    },
                    generatedMessage: `I need more details to help you effectively with "${input}". Could you provide more specific information about what you'd like to do?\n\nPlease provide the following information:\n1. What specifically are you looking for?\n2. Where should I look for this information?`
                };
                
                resultDiv.textContent = JSON.stringify(mockResult, null, 2);
                resultDiv.className = 'test-result warning';
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        async function testEnhancedPlanning() {
            const input = document.getElementById('planningInput').value;
            const resultDiv = document.getElementById('planningResult');
            
            resultDiv.textContent = 'Testing enhanced multi-step planning...';
            resultDiv.className = 'test-result';
            
            try {
                // Simulate enhanced planning
                const mockResult = {
                    ok: true,
                    plan: {
                        thought: `User wants comprehensive laptop research under $1000 in Singapore. I'll use multi-source search, research official and retail sources, compare specifications and prices, and provide detailed analysis.`,
                        steps: [
                            { tool: 'multi_search', params: { query: 'best laptop under $1000 singapore 2024', location: 'singapore', maxSearches: 4 } },
                            { tool: 'research_url', params: { url: 'https://www.dell.com/sg/', depth: 1, maxDepth: 2 } },
                            { tool: 'extract_structured_content', params: {} },
                            { tool: 'continue_multi_search', params: {} },
                            { tool: 'research_pricing', params: { product: 'laptop', location: 'singapore', sources: ['official', 'retail', 'comparison'] } },
                            { tool: 'get_page_links', params: { includeExternal: true, maxLinks: 15, filter: 'shopping' } },
                            { tool: 'compare_sources', params: { category: 'features', synthesize: true } },
                            { tool: 'generate_report', params: { format: 'markdown', content: 'Comprehensive laptop recommendations under $1000 for Singapore market' } },
                            { tool: 'done', params: { reason: 'Multi-source laptop research completed with comprehensive analysis' } }
                        ],
                        originalGoal: input,
                        refinedGoal: 'Find comprehensive laptop recommendations under $1000 SGD in Singapore including specifications, pricing, and availability from multiple sources',
                        refinementConfidence: 0.92,
                        enhancements: {
                            multiSourceSearch: true,
                            pricingData: true,
                            searchDepth: 3
                        }
                    }
                };
                
                resultDiv.textContent = JSON.stringify(mockResult, null, 2);
                resultDiv.className = 'test-result success';
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        async function checkSystemStatus() {
            const resultDiv = document.getElementById('statusResult');
            
            resultDiv.textContent = 'Checking system status...';
            resultDiv.className = 'test-result';
            
            try {
                const status = {
                    timestamp: new Date().toISOString(),
                    enhancedFeatures: {
                        intentClassification: '‚úÖ Enhanced with ambiguity detection',
                        multiStepPlanning: '‚úÖ Enhanced with query refinement',
                        pricingResearch: '‚úÖ Multi-source pricing tools',
                        clarificationSystem: '‚úÖ Interactive feedback loops',
                        chatLinkage: '‚úÖ Improved message routing',
                        urlResolution: '‚úÖ Enhanced navigation logic'
                    },
                    newMessageTypes: [
                        'CLASSIFY_INTENT_ENHANCED',
                        'REQUEST_CLARIFICATION', 
                        'RESPOND_CLARIFICATION',
                        'RESEARCH_PRICING',
                        'COMPARE_SOURCES',
                        'MULTI_SOURCE_SEARCH'
                    ],
                    newTools: [
                        'research_pricing',
                        'compare_sources', 
                        'smart_navigate',
                        'multi_search',
                        'continue_multi_search',
                        'analyze_url_depth'
                    ],
                    improvements: [
                        'Ambiguous query detection and clarification',
                        'Multi-source search with location awareness',
                        'Enhanced pricing research capabilities',
                        'Interactive clarification workflows',
                        'Better error handling and fallbacks',
                        'Improved URL resolution and navigation'
                    ]
                };
                
                resultDiv.textContent = JSON.stringify(status, null, 2);
                resultDiv.className = 'test-result success';
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.className = 'test-result error';
            }
        }

        // Helper functions
        function inferBasicIntent(input) {
            const lower = input.toLowerCase();
            if (lower.includes('youtube') || lower.includes('video')) return 'YOUTUBE';
            if (lower.includes('price') || lower.includes('buy') || lower.includes('shop')) return 'SHOPPING';
            if (lower.includes('research') || lower.includes('find') || lower.includes('what')) return 'RESEARCH';
            if (lower.includes('go to') || lower.includes('navigate') || lower.includes('open')) return 'NAVIGATION';
            if (lower.includes('click') || lower.includes('fill') || lower.includes('scroll')) return 'AUTOMATION';
            return 'CONVERSATION';
        }

        function checkAmbiguity(input) {
            const ambiguousPatterns = [
                /\b(that|this|it)\b/i,
                /\b(best|good|cheap)\b(?!\s+\w+)/i,
                /^(research|find|buy|get)\s*$/i,
                /\b(help|assist)\b.*\b(this|that)\b/i
            ];
            
            return ambiguousPatterns.some(pattern => pattern.test(input)) || input.trim().split(' ').length < 3;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Enhanced AI System Test Suite loaded');
        });
    </script>
</body>
</html>