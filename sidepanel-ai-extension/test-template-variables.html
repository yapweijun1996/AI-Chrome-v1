<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Variable Substitution Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
        }
        .input-group textarea {
            height: 60px;
            resize: vertical;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .template-vars {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Template Variable Substitution Test</h1>
        <p>This test verifies that the template variable substitution system correctly handles placeholders like <code>{{PREVIOUS_STEP_RESULT_URL_1}}</code>.</p>

        <div class="test-section">
            <h3>Template Variable Context Simulation</h3>
            <div class="template-vars">
                <strong>Available Template Variables:</strong><br>
                • PREVIOUS_RESEARCHED_URL<br>
                • PREVIOUS_STEP_RESULT_URL_1<br>
                • PREVIOUS_STEP_RESULT_URL_2<br>
                • PREVIOUS_STEP_RESULT_URL_3<br>
                • LAST_SEARCH_QUERY<br>
                • CURRENT_GOAL<br>
                • USER_LOCATION
            </div>
        </div>

        <div class="test-section">
            <h3>Test Template Substitution</h3>
            <div class="input-group">
                <label for="templateText">Template Text (use {{VARIABLE_NAME}} format):</label>
                <textarea id="templateText" placeholder='Example: Navigate to {{PREVIOUS_STEP_RESULT_URL_1}} and search for {{CURRENT_GOAL}}'></textarea>
            </div>
            <button onclick="testTemplateSubstitution()">Test Substitution</button>
            <div id="substitutionResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>Predefined Test Cases</h3>
            <button onclick="runTestCase1()">Test Case 1: PREVIOUS_STEP_RESULT_URL_1</button>
            <button onclick="runTestCase2()">Test Case 2: Multiple URL Variables</button>
            <button onclick="runTestCase3()">Test Case 3: Fallback Behavior</button>
            <div id="testCaseResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Simulate the template substitution functions from background.js
        function getUserLocationFromTimezone() {
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const timezoneLocationMap = {
                    'Asia/Singapore': 'singapore',
                    'Asia/Kuala_Lumpur': 'malaysia',
                    'America/New_York': 'usa',
                    'Europe/London': 'uk'
                };
                return timezoneLocationMap[timezone] || 'singapore';
            } catch (error) {
                return 'singapore';
            }
        }

        function buildTemplateContext(sess = {}) {
            const context = {
                CURRENT_URL: 'https://example.com',
                CURRENT_TITLE: 'Test Page',
                PREVIOUS_RESEARCHED_URL: 'https://www.apple.com/sg/ipad/',
                PREVIOUS_STEP_RESULT_URL_1: 'https://www.apple.com/sg/ipad/',
                PREVIOUS_STEP_RESULT_URL_2: 'https://www.google.com/search?q=ipad+price+singapore',
                PREVIOUS_STEP_RESULT_URL_3: 'https://www.amazon.sg/ipad',
                LAST_SEARCH_QUERY: 'ipad price singapore',
                CURRENT_SEARCH_RESULTS: '',
                CURRENT_SEARCH_TERM: 'ipad price',
                NEXT_SEARCH_TERM: 'ipad buy singapore',
                CURRENT_GOAL: sess.goal || 'find ipad price',
                CURRENT_SUBTASK: sess.subTask || 'research ipad pricing',
                USER_LOCATION: getUserLocationFromTimezone()
            };
            return context;
        }

        function getFallbackValue(variableName, context) {
            // Handle numbered URL variables
            if (variableName.startsWith('PREVIOUS_STEP_RESULT_URL_')) {
                const urlNumber = parseInt(variableName.split('_').pop());
                if (urlNumber && urlNumber >= 1) {
                    if (context.PREVIOUS_RESEARCHED_URL) {
                        return context.PREVIOUS_RESEARCHED_URL;
                    }
                    if (context.LAST_SEARCH_QUERY) {
                        return `https://www.google.com/search?q=${encodeURIComponent(context.LAST_SEARCH_QUERY)}`;
                    }
                    if (context.CURRENT_GOAL) {
                        return `https://www.google.com/search?q=${encodeURIComponent(context.CURRENT_GOAL)}`;
                    }
                    return 'https://www.google.com';
                }
            }
            
            switch (variableName) {
                case 'PREVIOUS_RESEARCHED_URL':
                    if (context.CURRENT_URL && context.CURRENT_URL !== 'about:blank') {
                        return context.CURRENT_URL;
                    }
                    if (context.LAST_SEARCH_QUERY) {
                        return `https://www.google.com/search?q=${encodeURIComponent(context.LAST_SEARCH_QUERY)}`;
                    }
                    return 'https://www.google.com';
                case 'LAST_SEARCH_QUERY':
                    return context.CURRENT_GOAL || 'information';
                case 'CURRENT_SEARCH_TERM':
                    return context.LAST_SEARCH_QUERY || context.CURRENT_GOAL || 'search';
                case 'USER_LOCATION':
                    return 'singapore';
                default:
                    return '';
            }
        }

        function substituteTemplateVariables(text, context) {
            if (!text || typeof text !== 'string') {
                return text;
            }

            let result = text;
            const templateRegex = /\{\{([A-Z_]+)\}\}/g;
            result = result.replace(templateRegex, (match, variableName) => {
                const value = context[variableName];
                if (value !== undefined && value !== '') {
                    return value;
                }
                return getFallbackValue(variableName, context);
            });

            return result;
        }

        function testTemplateSubstitution() {
            const templateText = document.getElementById('templateText').value;
            const resultDiv = document.getElementById('substitutionResult');
            
            if (!templateText.trim()) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please enter template text to test';
                resultDiv.style.display = 'block';
                return;
            }

            try {
                const context = buildTemplateContext();
                const result = substituteTemplateVariables(templateText, context);
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `<strong>Original:</strong> ${templateText}\n<strong>Substituted:</strong> ${result}`;
                resultDiv.style.display = 'block';
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error.message}`;
                resultDiv.style.display = 'block';
            }
        }

        function runTestCase1() {
            const testText = 'Navigate to {{PREVIOUS_STEP_RESULT_URL_1}} and extract content';
            const context = buildTemplateContext();
            const result = substituteTemplateVariables(testText, context);
            
            const resultDiv = document.getElementById('testCaseResult');
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `<strong>Test Case 1: PREVIOUS_STEP_RESULT_URL_1</strong>\n<strong>Template:</strong> ${testText}\n<strong>Result:</strong> ${result}\n<strong>Status:</strong> ${result.includes('{{') ? 'FAILED - Placeholder not replaced' : 'SUCCESS - Placeholder replaced'}`;
            resultDiv.style.display = 'block';
        }

        function runTestCase2() {
            const testText = 'Compare {{PREVIOUS_STEP_RESULT_URL_1}} with {{PREVIOUS_STEP_RESULT_URL_2}} and {{PREVIOUS_STEP_RESULT_URL_3}}';
            const context = buildTemplateContext();
            const result = substituteTemplateVariables(testText, context);
            
            const resultDiv = document.getElementById('testCaseResult');
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `<strong>Test Case 2: Multiple URL Variables</strong>\n<strong>Template:</strong> ${testText}\n<strong>Result:</strong> ${result}\n<strong>Status:</strong> ${result.includes('{{') ? 'FAILED - Some placeholders not replaced' : 'SUCCESS - All placeholders replaced'}`;
            resultDiv.style.display = 'block';
        }

        function runTestCase3() {
            const testText = 'Search for {{UNKNOWN_VARIABLE}} and navigate to {{PREVIOUS_STEP_RESULT_URL_99}}';
            const context = buildTemplateContext();
            const result = substituteTemplateVariables(testText, context);
            
            const resultDiv = document.getElementById('testCaseResult');
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `<strong>Test Case 3: Fallback Behavior</strong>\n<strong>Template:</strong> ${testText}\n<strong>Result:</strong> ${result}\n<strong>Status:</strong> Fallback system handled unknown variables`;
            resultDiv.style.display = 'block';
        }

        // Set default test text
        document.getElementById('templateText').value = 'Navigate to {{PREVIOUS_STEP_RESULT_URL_1}} and search for {{CURRENT_GOAL}} in {{USER_LOCATION}}';
    </script>
</body>
</html>